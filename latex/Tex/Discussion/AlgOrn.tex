\begin{code}%
\>[0]\AgdaSymbol{\{-\#}\AgdaSpace{}%
\AgdaKeyword{OPTIONS}\AgdaSpace{}%
\AgdaPragma{--type-in-type}\AgdaSpace{}%
\AgdaPragma{--with-K}\AgdaSpace{}%
\AgdaPragma{--allow-unsolved-metas}\AgdaSpace{}%
\AgdaSymbol{\#-\}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{Tex.Discussion.AlgOrn}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Agda.Primitive}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{using}%
\>[11]\AgdaSymbol{(}\AgdaSpace{}%
\AgdaPostulate{Level}\<%
\\
%
\>[11]\AgdaSymbol{;}\AgdaSpace{}%
\AgdaPrimitive{SSet}\AgdaSpace{}%
\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{renaming}%
\>[12I]\AgdaSymbol{(}\AgdaSpace{}%
\AgdaPrimitive{lzero}\AgdaSpace{}%
\AgdaSymbol{to}\AgdaSpace{}%
\AgdaPrimitive{ℓ-zero}\<%
\\
\>[.][@{}l@{}]\<[12I]%
\>[11]\AgdaSymbol{;}\AgdaSpace{}%
\AgdaPrimitive{lsuc}%
\>[19]\AgdaSymbol{to}\AgdaSpace{}%
\AgdaPrimitive{ℓ-suc}\<%
\\
%
\>[11]\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{\AgdaUnderscore{}⊔\AgdaUnderscore{}}}%
\>[19]\AgdaSymbol{to}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{ℓ-max}}\<%
\\
%
\>[11]\AgdaSymbol{;}\AgdaSpace{}%
\AgdaPrimitive{Set}%
\>[19]\AgdaSymbol{to}\AgdaSpace{}%
\AgdaPrimitive{Type}\<%
\\
%
\>[11]\AgdaSymbol{;}\AgdaSpace{}%
\AgdaPrimitive{Setω}%
\>[19]\AgdaSymbol{to}\AgdaSpace{}%
\AgdaPrimitive{Typeω}\AgdaSpace{}%
\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Binary.PropositionalEquality}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{J}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Unit}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Empty}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Vec}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Product}\AgdaSpace{}%
\AgdaKeyword{renaming}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{proj₁}\AgdaSpace{}%
\AgdaSymbol{to}\AgdaSpace{}%
\AgdaField{fst}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaField{proj₂}\AgdaSpace{}%
\AgdaSymbol{to}\AgdaSpace{}%
\AgdaField{snd}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Sum}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{map₂}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Function.Base}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Ornament.Desc}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Ornament.OrnDesc}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Ornament.Numerical}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaKeyword{variable}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaGeneralizable{Me}\AgdaSpace{}%
\AgdaGeneralizable{Me′}\AgdaSpace{}%
\AgdaGeneralizable{Me″}\AgdaSpace{}%
\AgdaGeneralizable{Me‴}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Meta}\<%
\\
%
\>[2]\AgdaGeneralizable{I}\AgdaSpace{}%
\AgdaGeneralizable{J}\AgdaSpace{}%
\AgdaGeneralizable{K}\AgdaSpace{}%
\AgdaGeneralizable{M}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Type}\<%
\\
%
\>[2]\AgdaGeneralizable{A}\AgdaSpace{}%
\AgdaGeneralizable{B}\AgdaSpace{}%
\AgdaGeneralizable{C}\AgdaSpace{}%
\AgdaGeneralizable{X}\AgdaSpace{}%
\AgdaGeneralizable{Y}\AgdaSpace{}%
\AgdaGeneralizable{Z}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Type}\<%
\\
%
\>[2]\AgdaGeneralizable{P}\AgdaSpace{}%
\AgdaGeneralizable{P′}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Type}\<%
\\
%
\>[2]\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\AgdaSpace{}%
\AgdaGeneralizable{Θ}\AgdaSpace{}%
\AgdaGeneralizable{Λ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Tel}\AgdaSpace{}%
\AgdaGeneralizable{P}\<%
\\
%
\>[2]\AgdaGeneralizable{D}\AgdaSpace{}%
\AgdaGeneralizable{E}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{DescI}\AgdaSpace{}%
\AgdaGeneralizable{Me}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{I}\<%
\\
%
\>[2]\AgdaGeneralizable{U}\AgdaSpace{}%
\AgdaGeneralizable{V}\AgdaSpace{}%
\AgdaGeneralizable{W}%
\>[10]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{ExTel}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\<%
\\
%
\>[2]\AgdaGeneralizable{CD}\AgdaSpace{}%
\AgdaGeneralizable{CE}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ConI}\AgdaSpace{}%
\AgdaGeneralizable{Me}\AgdaSpace{}%
\AgdaGeneralizable{Γ}\AgdaSpace{}%
\AgdaGeneralizable{V}\AgdaSpace{}%
\AgdaGeneralizable{I}\<%
\\
%
\>[2]\AgdaGeneralizable{V′}\AgdaSpace{}%
\AgdaGeneralizable{W′}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{ExTel}\AgdaSpace{}%
\AgdaGeneralizable{Δ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Meta}\<%
\end{code}

%<*almost-algorn>
algOrn   : ∀ {J} (D : Desc ∅ I)
         → (⟦ D ⟧D J →₃ J)
         → OrnDesc Plain ∅ id (Σ I (J tt)) fst D
         
algOrnC  : ∀ {W J} (C : Con ∅ V I) (c : Vxf id W V)
         → (∀ p i → ⟦ C ⟧C J (var→par c p) i → J (fst p) i)
         → ConOrnDesc {J = Σ I (J tt)} Plain c fst C

algOrn []       ϕ  = []
algOrn (C ∷ D)  ϕ  = algOrnC C id (λ p i x → ϕ (fst p) i (inj₁ x))
                   ∷ algOrn D λ p i x → ϕ p i (inj₂ x)

algOrnC  (𝟙 j) c ϕ = 𝟙 (λ pv → j (var→par c pv) , ϕ pv _ refl) (λ a → refl)
algOrnC  {J = J} (ρ g j C) c ϕ
         = OΔσ+ (λ { (_ , pw) → J _ (j (var→par c (_ , pw))) })
         ( Oρ0 (λ { (_ , (pw , i)) → j (var→par c (_ , pw)) , i }) (λ a → refl)
         ( algOrnC C (c ∘ fst) λ { (_ , (pw , j)) i x → ϕ (_ , pw) i (j , x) }))
algOrnC  (σ S h C) c ϕ
         = Oσ+ S
         ( algOrnC  C (h ∘ Vxf-▷ c S)
                    (λ { (_ , (pw , s)) i x → ϕ (_ , pw) i (s , x) }))
algOrnC  {I = I} {J = J} (δ g j R C) c ϕ
         = δ R g j
         ( algOrnC  C c
                    (λ { (_ , w) i x → ϕ (_ , w) i ({!!} , x) }))
%</almost-algorn>

%<*almost-algorn2>
algOrn2  : ∀ {J : ⊤ → ⊤ → Type} (D : DescI Me Γ ⊤)
         → MetaF Me Number
         → (∀ p i → ⟦ D ⟧D (λ _ _ → J tt tt) p i → J tt tt)
         → OrnDesc Plain Γ id (J tt tt) ! D
         
algOrn2C  : ∀ {W} {J : ⊤ → ⊤ → Type} (C : ConI Me Γ V ⊤)
          → MetaF Me Number
          → (c : Vxf id W V)
          → (∀ p i → ⟦ C ⟧C (λ p i → J tt tt) (var→par c p) i → J tt tt)
          → ConOrnDesc {Δ = Γ} {W = W} {J = J tt tt} Plain c ! C

algOrn2 []       iff ϕ  = []
algOrn2 (C ∷ D)  iff ϕ  = algOrn2C C iff id (λ p i x → ϕ (fst p) i (inj₁ x))
                        ∷ algOrn2 D iff λ p i x → ϕ p i (inj₂ x)

algOrn2C  (𝟙 j) iff c ϕ = 𝟙 (λ pv → ϕ pv tt refl) (λ a → refl)
algOrn2C  {J = J} (ρ j g C) iff c ϕ
          = OΔσ+ (λ _ → J tt tt)
          ( ρ (λ { (_ , (_ , i)) → i }) g (λ _ → refl) (λ a → refl)
          ( algOrn2C C iff (c ∘ fst) λ { (p , w , j) i x → ϕ (p , w) tt (j , x) }))
algOrn2C  (σ S h C) iff c ϕ
          = Oσ+ S
          ( algOrn2C C iff (h ∘ Vxf-▷ c S)
                    λ { (p , w , s) i x → ϕ (p , w) i (s , x) })
algOrn2C  {J = J} (δ {me = me′} {iff = iff′} j g R h C) iff c ϕ
          with iff .δf _ _ me′
... | refl , refl , _
          = OΔσ+ (λ { w → μ R (g (var→par c w)) (j (var→par c w)) } )
          ( O∙δ+ {!!} ! (algOrn2 R (iff ∘MetaF iff′) {!didn't think about what J would actually be here!}) (λ _ _ → refl) (λ _ _ → refl) (algOrn2C C iff _ λ { (p , (w , r) , z) i x → ϕ (p , w) tt
          (r , subst (λ a → ⟦ C ⟧C (λ _ _ → J tt tt) (p , h (c w , a)) tt) {!reassuringly/unfortunately?, this is blocked by the same problem as indexed numerical representations!} x) }))
%</almost-algorn2>


-- shortcut is algOrn applied to (toDesc OD) with (ornAlg OD)

shortcut  : {D : DescI Me ∅ ⊤} {E : DescI Me ∅ ⊤} (OD : OrnDesc Plain Γ ! I ! D)
          → MetaF Me Number
          → OrnDesc Me Γ id (Σ I λ i → μ E _ _) fst (toDesc OD)
         
shortcutC  : ∀ {E : DescI Me ∅ ⊤} {U W} {f : Vxf ! W V} {g : Vxf id U W}
           → {C : ConI Me ∅ V ⊤}
           → (OC : ConOrnDesc {Δ = Γ} {W = W} {J = I} Plain f ! C)
           → MetaF Me Number
           → ConOrnDesc {Δ = Γ} {W = U} {J = Σ I λ i → μ E _ _} Me g fst (toCon OC)

shortcut [] iff = []
shortcut (OC ∷ OD) iff
  = shortcutC OC iff 
  ∷ shortcut OD iff  

shortcutC (𝟙 j′ x₁) iff = 𝟙 (λ pv → {!still need a ⟦ toDesc OC ⟧C (~~ μ E ~~) →₃ ~~ μ E ~~ like object here!}) {!!}
shortcutC (ρ j′ h x₁ x₂ OC) iff = {!!}
shortcutC (σ S h v′ x₁ OC) iff = {!!}
shortcutC (δ R j t h x₁ OC) iff = {!!}
shortcutC (Δσ S h v′ x₁ OC) iff = {!!}
shortcutC (Δδ R j t h x₁ OC) iff = {!!}
shortcutC (∙δ m fΛ RR′ h p₁ p₂ OC) iff = {!!}
